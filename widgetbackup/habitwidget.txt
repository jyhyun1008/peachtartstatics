### {
	name: 'í”¼ì¹˜íƒ€ë£¸ í•´ë¹—íŠ¸ë˜ì»¤'
	author: '@hyun1008@i.peacht.art'
	version: 1
	description: 'í•´ë¹—íŠ¸ë˜ì»¤ì˜ í”¼ì¹˜íƒ€ë£¸ ì—°ë™ ë²„ì „'
	permissions: ['write:notes']
}

// ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ë³€ìˆ˜ ---

// ê³µê°œ ë²”ìœ„ (í¼ë¸”ë¦­/í™ˆ/íŒ”ë¡œì›Œ)
var vis = 'public' // 'public', 'home', 'followers'
// ìŠµê´€ ëª©ë¡ (í•œ ì¤„ì— í•˜ë‚˜ì”©)
let HABITS = [
  'ë¬¼'
  'ì‚°ì±…'
  'ëŒ„ìŠ¤'
  'í•´ê¸ˆ'
  'ë…ì„œ'
  'ì¼ê¸°'
  'ì‘ì—…'
  'ê³¼ì œ'
]
// ëë‚¸ ì¼ ì—ëª¨ì§€ - ì‚¬ê°í˜• ê³„ì—´ë¡œ í•˜ì‹œëŠ” ê²ƒì„ ê°•ë ¥í•˜ê²Œ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.
let emoji = 'ğŸŸ¨'

let myId = Mk:api('i' {}).username

//ê¸€ìê¸¸ì´ ë§ì¶”ê¸°(4ê¸€ì ì´ìƒì´ë©´ ìë¦„)
let mHABITS = []
each (let habit, HABITS) {
    if (habit.len) < 4 {
        let margin = 4 - habit.len
        for (let i, margin) {
            habit = `ã€€{habit}`
        }
    } else if (habit.len > 4) {
        habit = habit.slice(0, 4)
    }
    mHABITS.push(habit)
}

@NewNote(id, txt) {
    var createdNote = Mk:api('notes/create' {
        visibility: vis,
        text: txt
    }).createdNote.id

	let notes = Mk:api('notes/search-by-tag' { tag: `{myId}_HabitTracker` })
	var noteId = ''
	each (let note, notes) {
		let userName = note.user.username
		if userName == myId && note.id != createdNote {
			noteId = note.id
			break
		}
	}

	if noteId != '' {
		Mk:api('notes/delete' {
			noteId: noteId
		})
	}
}

var streak = 1

@getPostButtons(habits){
  let buttons = []
  let notes = Mk:api('notes/search-by-tag' { tag: `{myId}_HabitTracker`, limit: 10, })
  let isLast = 0
  let lastNoteInterval = 0
  let NoteInterval = 0
  var noteTextArray = habits
  var noteId = ''
  streak = 1
  each (let note, notes) {
    let userName = note.user.username
    if userName == myId {
      let noteCreatedAt = Date:daysFromEpoch(Date:parse(note.createdAt))
      NoteInterval = Date:daysFromEpoch(Date:now()) - noteCreatedAt
      var noteText = note.text
      if NoteInterval > 0 {
        if noteText.incl(emoji) || noteText.incl('â¬œï¸') {
          isLast = isLast + 1
          if isLast == 1 {
            lastNoteInterval = NoteInterval
            noteTextArray = noteText.split(Str:lf)
            if lastNoteInterval == 1 {
              if noteText.incl('ë²Œì¨ ') {
                streak = note.text.split('ë²Œì¨ ')[1].split(' ì¼ ì—°ì†ìœ¼ë¡œ')[0].to_num() + 1
              } else {
                streak = 2
              }
            }
          }
        }
      } else if NoteInterval == 0 {
        if noteText.incl(emoji) || noteText.incl('â¬œï¸') {
          isLast = isLast + 1
          if isLast == 1 {
            lastNoteInterval = NoteInterval
            noteId = note.id
            noteTextArray = noteText.split(Str:lf)
            if noteText.incl('ë²Œì¨ ') {
              streak = note.text.split('ë²Œì¨ ')[1].split(' ì¼ ì—°ì†ìœ¼ë¡œ')[0].to_num()
            } else {
              streak = 1
            }
          }
        }
      }
    }
  }

each (let habit, habits) {
    var title = habit
    var txt = []
    for (let i, habits.len) {
      txt.push(['`' mHABITS[i]])
      txt[i].push('`')
      txt[i].join()
      var habitTrackArray = []
      if (noteTextArray.incl(txt[i])) {
        for (let j, noteTextArray.len) {
            if (noteTextArray[j].incl(' ') && txt[i] == noteTextArray[j].split(' ')[0]) { // ê°™ì€ í•­ëª©ì´ ìˆëŠ” ê²½ìš° 
                habitTrackArray = noteTextArray[j].split(' ')[1].split()
                if (Core:type(habitTrackArray) == 'str') {
                    habitTrackArray = [habitTrackArray]
                    
                    if lastNoteInterval == 0 {
                        if habits[i] == habit {
                        if habitTrackArray[habitTrackArray.len-1] == emoji {
                            habitTrackArray[habitTrackArray.len-1] = 'â¬œï¸'
                        } else if habitTrackArray[habitTrackArray.len-1] == 'â¬œï¸' {
                            habitTrackArray[habitTrackArray.len-1] = emoji
                        }
                        }
                    } else if (lastNoteInterval > 0) {
                        for (let j, lastNoteInterval - 1) {
                        habitTrackArray.push('â¬œï¸')
                        }
                        if habits[i] == habit {
                        habitTrackArray.push(emoji)
                        } else {
                        habitTrackArray.push('â¬œï¸')
                        }
                    }
                    if habitTrackArray.len > 9 {
                        habitTrackArray = habitTrackArray.slice(habitTrackArray.len - 10, habitTrackArray.len)
                    }
                }

                break
            }
        }
      } else {
        for (let j, streak) {
            
            habitTrackArray.push('â¬œï¸')
        }
      }

      
      txt[i].push(' ')
      txt[i].push(habitTrackArray.join())
      txt[i] = txt[i].join()
    }
    txt.push(`ë²Œì¨ {streak.to_str()}ì¼ ì—°ì†ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ìˆì–´ìš”!`)
    txt.push(` #{myId}_HabitTracker #kcal-c https://i.peacht.art/@hyun1008/pages/kcal-c `)
    txt = txt.join(Str:lf)
    buttons.push({
      text: title
      onClick: @() {NewNote(noteId, txt)}
    })
  }
  buttons

}

Ui:render([
  Ui:C:container({ 
    align: 'center'
    children: [
      Ui:C:mfm( { bgColor: 'grey', text: 'í”¼ì¹˜íƒ€ë£¸ í•´ë¹—íŠ¸ë˜ì»¤' } )
      Ui:C:buttons({
        buttons: getPostButtons(HABITS)
      })
    ]
  })
])